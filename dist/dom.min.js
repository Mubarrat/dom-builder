/*!
 * Dom-Builder JavaScript Library v4.0.0
 * https://github.com/Mubarrat/dom-builder/
 * 
 * Released under the MIT license
 * https://github.com/Mubarrat/dom-builder/blob/main/LICENSE
 */
/// <reference path="./dom.d.ts" />
"use strict";class ValueChangeEvent extends Event{constructor(e,t,r){super(e,r),t&&Object.assign(this,t)}}function baseObservable(e){const t=(...t)=>e(...t);return Object.setPrototypeOf(t,baseObservable.prototype),t._eventTarget=new EventTarget,t}function arrayObservable(e){const t=[...e],r=baseObservable(()=>[...t]);return Object.setPrototypeOf(r,arrayObservable.prototype),new Proxy(r,{get(e,r,n){switch(r){case"push":return(...r)=>e.tryChange(()=>t.push(...r),{index:t.length,newItems:r})??t.length;case"pop":return()=>{if(0!==t.length)return e.tryChange(()=>t.pop(),{index:t.length-1,oldItems:[t[t.length-1]]})};case"shift":return()=>{if(0!==t.length)return e.tryChange(()=>t.shift(),{index:0,oldItems:[t[0]]})};case"unshift":return(...r)=>e.tryChange(()=>t.unshift(...r),{index:0,newItems:r})??t.length;case"splice":return(r,n,...o)=>(r<0&&(r=t.length+r),void 0===n&&(n=t.length-r),e.tryChange(()=>t.splice(r,n,...o),{index:r,newItems:o.length?o:void 0,oldItems:t.slice(r,r+n)})??[]);case"reverse":return()=>(e.tryChange(t.reverse,{reversed:!0}),n);case"sort":return r=>{if(!e.notifyBefore({sortFn:r||null}))return n;const o=[...t];t.sort(r);const s=o.map(e=>t.indexOf(e));return e.notify({sortedIndices:s}),n};case"fill":return(r,o,s)=>(null==o&&(o=0),null==s&&(s=t.length),e.tryChange(()=>t.fill(r,o,s),{index:o,newItems:Array(s-o).fill(r),oldItems:t.slice(o,s)}),n);case"copyWithin":return(r,o,s)=>(null==o&&(o=0),null==s&&(s=t.length),e.tryChange(()=>t.copyWithin(r,o,s),{index:r,newItems:t.slice(o,s),oldItems:t.slice(r,r+(s-o))}),n);default:return Reflect.get(t,r,n)??Reflect.get(e,r,n)}},set(e,r,n,o){if("string"==typeof r){const o=Number(r);if(Number.isInteger(o)&&o>=0&&String(o)===r&&!Object.is(t[o],n))return e.tryChange(()=>(t[o]=n,!0),{index:o,newItems:[n],oldItems:[t[o]]})??!1}if("length"===r){const r=t.length,o=Number(n);return e.tryChange(()=>(t.length=o,!0),o<r?{index:o,oldItems:t.slice(o)}:{index:r,newItems:Array(o-r)})??!1}return Reflect.set(e,r,n,o)},has(e,r){if("length"===r)return!0;if("string"==typeof r){const e=Number(r);if(Number.isInteger(e)&&e>=0&&String(e)===r)return e<t.length}return r in e},ownKeys:e=>Array.from({length:t.length},(e,t)=>t.toString()).concat(Object.getOwnPropertyNames(e)),getOwnPropertyDescriptor(e,r){if("string"==typeof r){const e=Number(r);if(Number.isInteger(e)&&e>=0&&String(e)===r)return{configurable:!0,enumerable:!0,value:t[e],writable:!0}}return"length"===r?{configurable:!1,enumerable:!1,value:t.length,writable:!0}:Object.getOwnPropertyDescriptor(e,r)}})}function cstr(e,...t){const r=t.filter(e=>e instanceof baseObservable);return 0===r.length?e.reduce((e,r,n)=>e+r+(n<t.length?String(t[n]):""),""):(()=>{let r=e[0];for(let n=0;n<t.length;n++){const o=t[n];r+=String(o instanceof baseObservable?o():o),r+=e[n+1]}return r}).computed(...r)}Object.setPrototypeOf(baseObservable.prototype,EventTarget.prototype),Object.setPrototypeOf(baseObservable,EventTarget),baseObservable.prototype.addEventListener=function(...e){return this._eventTarget.addEventListener(...e)},baseObservable.prototype.removeEventListener=function(...e){return this._eventTarget.removeEventListener(...e)},baseObservable.prototype.dispatchEvent=function(...e){return this._eventTarget.dispatchEvent(...e)},baseObservable.prototype.type="to",baseObservable.prototype.notifyBefore=function(e){return this.dispatchEvent(new ValueChangeEvent("valuechanging",e,{cancelable:!0}))},baseObservable.prototype.notify=function(e){this.dispatchEvent(new ValueChangeEvent("valuechanged",e))},baseObservable.prototype.tryChange=function(e,t){if(!this.notifyBefore(t))return;const r=e();return this.notify(t),r},baseObservable.prototype.bindSelect=function(e){return(()=>e(this())).computed(this)},baseObservable.prototype.validatable=function(e=()=>!0){return Object.setPrototypeOf(Object.assign((...e)=>this(...e),{isValid:(()=>e(this())).computed(this)}),this)},baseObservable.prototype.coercible=function(e=e=>e){return Object.setPrototypeOf((...t)=>{if(0===t.length)return this();const r=e(...t);return Array.isArray(r)?this(...r):this(r)},this)},Object.defineProperty(baseObservable.prototype,Symbol.toStringTag,{value:"baseObservable",writable:!1,enumerable:!1,configurable:!1}),baseObservable.autoBind=(e,t,r)=>{if(!(e instanceof baseObservable))return void t(e);const n=e();t(n),"to"!==e.type&&"two-way"!==e.type||e.addEventListener("valuechanged",()=>t(e())),"from"!==e.type&&"two-way"!==e.type||r?.(n)},Object.setPrototypeOf(arrayObservable.prototype,baseObservable.prototype),Object.setPrototypeOf(arrayObservable,baseObservable),arrayObservable.prototype.bindMap=function(e){const t=arrayObservable(this.map((t,r)=>e.call(this,t,r,this)));return this.addEventListener("valuechanged",r=>{if("index"in r){const{index:n,newItems:o,oldItems:s}=r;(s&&s.length||o&&o.length)&&t.splice(n,s?.length??0,...o?.map((t,r)=>e.call(this,t,n+r,this))??[])}"reversed"in r&&t.reverse(),"sortFn"in r&&t.sort()}),new Proxy(t,{get:(e,t,r)=>["push","pop","shift","unshift","splice","reverse","sort","fill","copyWithin"].includes(String(t))?()=>{throw new Error("Cannot modify a read-only mapped observable")}:Reflect.get(e,t,r),set(e,t,r,n){if("string"==typeof t){const e=Number(t);if(Number.isInteger(e)&&e>=0&&String(e)===t)throw new Error("Cannot modify any item of a read-only mapped observable")}if("length"===t)throw new Error("Cannot modify length of a read-only mapped observable");return Reflect.set(e,t,r,n)}})},arrayObservable.prototype.optimistic=function(e,t){const r=[...this];return e(this),t.catch(e=>{throw this.splice(0,this.length,...r),e})},Object.defineProperty(arrayObservable.prototype,Symbol.toStringTag,{value:"arrayObservable",writable:!1,enumerable:!1,configurable:!1}),Function.prototype.computed=function(...e){const t=baseObservable(this);return e.forEach(e=>{e instanceof baseObservable&&e.addEventListener("valuechanged",t.notify)}),Object.setPrototypeOf(t,Function.prototype.computed.prototype),t},Function.prototype.computed.prototype=Object.create(baseObservable.prototype),Function.prototype.computed.prototype.constructor=Function.prototype.computed,Object.setPrototypeOf(Function.prototype.computed,baseObservable),Object.defineProperty(Function.prototype.computed.prototype,Symbol.toStringTag,{value:"computed",writable:!1,enumerable:!1,configurable:!1});{const e=new WeakMap;new MutationObserver(t=>t.forEach(t=>e.get(t.target)?.get(t.attributeName)?.forEach(e=>e()))).observe(document,{attributes:!0,subtree:!0});var observeElementAttr=(t,r,n)=>{let o=e.get(t);o||e.set(t,o=new Map);let s=o.get(r);s||o.set(r,s=new Set),s.add(n)}}function observable(e=void 0){let t=e;const r=baseObservable(function(e){return 0===arguments.length||Object.is(t,e)||r.tryChange(()=>t=e,{oldValue:t,newValue:e}),t});return Object.setPrototypeOf(r,observable.prototype),r.bindTo=Object.setPrototypeOf(Object.assign((...e)=>r(...e),{type:"to"}),r),r.bindFrom=Object.setPrototypeOf(Object.assign((...e)=>r(...e),{type:"from"}),r),r}Object.defineProperties(Document.prototype,{$dom:{value(e){return new Proxy({},{get:(t,r)=>{if("string"!=typeof r)return;if("toString"===r)return()=>`DOM Proxy for namespace: ${e}`;const n=r.replace(/([A-Z])/g,"-$1").toLowerCase();return(...t)=>{const r=this.createElementNS(e,n);for(const i of s(t))if(null!=i&&!1!==i)if(i.constructor===Object&&void 0===i[Symbol.iterator]&&Symbol.asyncIterator&&void 0===i[Symbol.asyncIterator])for(const[l,b]of Object.entries(i))if("style"===l)baseObservable.autoBind(b,e=>"string"==typeof e?r.setAttribute("style",e):Object.entries(e).forEach(([e,t])=>baseObservable.autoBind(t,t=>r.style[e]=t,()=>observeElementAttr(r,"style",()=>t(r.style[e])))),e=>observeElementAttr(r,"style",()=>b("string"==typeof e?r.getAttribute("style")||"":Object.assign({},r.style))));else if("on"===l&&"object"==typeof b&&b)for(const[c,u]of Object.entries(b))for(const p of s([u]))"function"==typeof p&&r.addEventListener(c.toLowerCase(),p);else if(l.startsWith("on"))for(const f of s([b]))"function"==typeof f&&r.addEventListener(l.slice(2).toLowerCase(),f);else if("data"===l&&"object"==typeof b)for(const[y,g]of Object.entries(b))baseObservable.autoBind(g,e=>r.dataset[y]="object"==typeof e?JSON.stringify(e):e,e=>observeElementAttr(r,`data-${y}`,()=>{const e=r.dataset[y];try{g(JSON.parse(e))}catch{g(e)}}));else if(l.toLowerCase().startsWith("ref"))for(const h of s([b]))"function"==typeof h&&h.bind(r,r);else"value"===l&&(r instanceof HTMLInputElement||r instanceof HTMLTextAreaElement||r instanceof HTMLSelectElement)?baseObservable.autoBind(b,e=>r.value=e,()=>r.addEventListener(r instanceof HTMLSelectElement?"change":"input",()=>b(r.value))):"checked"===l&&r instanceof HTMLInputElement&&("checkbox"===r.type||"radio"===r.type)?baseObservable.autoBind(b,e=>r.checked=e,()=>r.addEventListener("change",()=>b(r.checked))):void 0!==b&&baseObservable.autoBind(b,e=>l in r?r[l]=e:r.setAttribute(l,"object"==typeof e?JSON.stringify(e):e),()=>{let e=l in r?r[l]:r.getAttribute(l);try{b(JSON.parse(e))}catch{b(e)}});else if(i instanceof baseObservable)if(i instanceof arrayObservable){const d=new Text;function v(){throw new Error("Implementation is in progress...")}r.append(d),v(),i.addEventListener("valuechanged",v)}else{const m=new Text;r.append(m);let O=[];function w(){for(const e of O)e.remove();let e=i();for(;"function"==typeof e;)e=e.call(r,r);const t=new DocumentFragment;t.append(...a(e).filter(e=>null!=e&&!1!==e)),O=Array.from(t.children),m.after(t)}w(),i.addEventListener("valuechanged",w)}else Symbol.asyncIterator?function e(t,n){for(const o of a(t).filter(e=>null!=e&&!1!==e&&void 0!==e))if("function"==typeof o[Symbol.asyncIterator]){const t=new Text;n?n.before(t):r.append(t),(async()=>{for await(const r of o)e(r,t)})()}else n?n.before(o):r.append(o)}(i):r.append(...a(i).filter(e=>null!=e&&!1!==e));return r;function o(e){return!(null==e||"string"==typeof e||"function"==typeof e||"function"!=typeof e[Symbol.iterator]||e instanceof Node||e instanceof Date||e instanceof RegExp)}function s(e){return o(e)?Array.from(e).flatMap(s):[e]}function a(e){for(;"function"==typeof e;)e=e.call(r,r);return o(e)?Array.from(e).flatMap(a):[e]}}}})},configurable:!1,enumerable:!0},$html:{get(){return this.$dom("http://www.w3.org/1999/xhtml")},configurable:!1,enumerable:!0},$svg:{get(){return this.$dom("http://www.w3.org/2000/svg")},configurable:!1,enumerable:!0},$mml:{get(){return this.$dom("http://www.w3.org/1998/Math/MathML")},configurable:!1,enumerable:!0}}),Object.defineProperties(Window.prototype,{$dom:{get(){return this.document.$dom},configurable:!1,enumerable:!0},$html:{get(){return this.document.$html},configurable:!1,enumerable:!0},$svg:{get(){return this.document.$svg},configurable:!1,enumerable:!0},$mml:{get(){return this.document.$mml},configurable:!1,enumerable:!0}}),Object.setPrototypeOf(observable.prototype,baseObservable.prototype),Object.setPrototypeOf(observable,baseObservable),observable.prototype.type="two-way",observable.prototype.optimistic=function(e,t){const r=this();return this(e(r)),t.catch(e=>{throw this(r),e})},Object.defineProperty(observable.prototype,Symbol.toStringTag,{value:"observable",writable:!1,enumerable:!1,configurable:!1});
//# sourceMappingURL=dom.min.js.map
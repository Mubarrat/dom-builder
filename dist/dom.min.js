/*!
 * Dom-Builder JavaScript Library v4.0.0
 * https://github.com/Mubarrat/dom-builder/
 * 
 * Released under the MIT license
 * https://github.com/Mubarrat/dom-builder/blob/main/LICENSE
 */
/// <reference path="./dom.d.ts" />
"use strict";class ValueChangeEvent extends Event{constructor(e,t,n){super(e,n),t&&Object.assign(this,t)}}const baseObservable=function(e){const t=(...t)=>e(...t);return Object.setPrototypeOf(t,baseObservable.prototype),t._eventTarget=new EventTarget,t};Object.setPrototypeOf(baseObservable.prototype,EventTarget.prototype),Object.setPrototypeOf(baseObservable,EventTarget),baseObservable.prototype.addEventListener=function(...e){return this._eventTarget.addEventListener(...e)},baseObservable.prototype.removeEventListener=function(...e){return this._eventTarget.removeEventListener(...e)},baseObservable.prototype.dispatchEvent=function(...e){return this._eventTarget.dispatchEvent(...e)},Object.defineProperty(baseObservable.prototype,"type",{value:"to",writable:!1,configurable:!1,enumerable:!0}),baseObservable.prototype.notifyBefore=function(e){return this.dispatchEvent(new ValueChangeEvent("valuechanging",e,{cancelable:!0}))},baseObservable.prototype.notify=function(e){this.dispatchEvent(new ValueChangeEvent("valuechanged",e))},baseObservable.prototype.tryChange=function(e,t){if(!this.notifyBefore(t))return;const n=e();return this.notify(t),n},baseObservable.prototype.bindSelect=function(e){return(()=>e(this())).computed(this)},baseObservable.prototype.validatable=function(e=()=>!0){return Object.setPrototypeOf(Object.assign((...e)=>this(...e),{isValid:(()=>e(this())).computed(this)}),this)},baseObservable.prototype.coercible=function(e=e=>e){return Object.setPrototypeOf((...t)=>{if(0===t.length)return this();const n=e(...t);return Array.isArray(n)?this(...n):this(n)},this)},Object.defineProperty(baseObservable.prototype,Symbol.toStringTag,{value:"baseObservable",writable:!1,enumerable:!1,configurable:!1}),baseObservable.autoBind=(e,t,n)=>{if(!(e instanceof baseObservable))return t(e),()=>{};t(e());const r=()=>t(e());return"to"!==e.type&&"two-way"!==e.type||e.addEventListener("valuechanged",r),"from"!==e.type&&"two-way"!==e.type||n?.(e()),()=>{"to"!==e.type&&"two-way"!==e.type||e.removeEventListener("valuechanged",r)}};const arrayObservable=function(e){const t=[...e],n=baseObservable(()=>[...t]);return Object.setPrototypeOf(n,arrayObservable.prototype),new Proxy(n,{get(e,n,r){switch(n){case"push":return(...n)=>e.tryChange(()=>t.push(...n),{index:t.length,newItems:n})??t.length;case"pop":return()=>{if(0!==t.length)return e.tryChange(()=>t.pop(),{index:t.length-1,oldItems:[t[t.length-1]]})};case"shift":return()=>{if(0!==t.length)return e.tryChange(()=>t.shift(),{index:0,oldItems:[t[0]]})};case"unshift":return(...n)=>e.tryChange(()=>t.unshift(...n),{index:0,newItems:n})??t.length;case"splice":return(n,r,...o)=>(n<0&&(n=t.length+n),void 0===r&&(r=t.length-n),e.tryChange(()=>t.splice(n,r,...o),{index:n,newItems:o.length?o:void 0,oldItems:t.slice(n,n+r)})??[]);case"reverse":return()=>(e.tryChange(()=>t.reverse(),{reversed:!0}),r);case"sort":return n=>{if(!e.notifyBefore({sortFn:n||null}))return r;const o=[...t];t.sort(n);const s=o.map(e=>t.indexOf(e));return e.notify({sortedIndices:s}),r};case"fill":return(n,o,s)=>(null==o&&(o=0),null==s&&(s=t.length),e.tryChange(()=>t.fill(n,o,s),{index:o,newItems:Array(s-o).fill(n),oldItems:t.slice(o,s)}),r);case"copyWithin":return(n,o,s)=>(null==o&&(o=0),null==s&&(s=t.length),e.tryChange(()=>t.copyWithin(n,o,s),{index:n,newItems:t.slice(o,s),oldItems:t.slice(n,n+(s-o))}),r);default:return Reflect.get(t,n,r)??Reflect.get(e,n,r)}},set(e,n,r,o){if("string"==typeof n){const o=Number(n);if(Number.isInteger(o)&&o>=0&&String(o)===n&&!Object.is(t[o],r))return e.tryChange(()=>(t[o]=r,!0),{index:o,newItems:[r],oldItems:[t[o]]})??!1}if("length"===n){const n=t.length,o=Number(r);return e.tryChange(()=>(t.length=o,!0),o<n?{index:o,oldItems:t.slice(o)}:{index:n,newItems:Array(o-n)})??!1}return Reflect.set(e,n,r,o)},has(e,n){if("length"===n)return!0;if("string"==typeof n){const e=Number(n);if(Number.isInteger(e)&&e>=0&&String(e)===n)return e<t.length}return n in e},ownKeys:e=>Array.from({length:t.length},(e,t)=>t.toString()).concat(Object.getOwnPropertyNames(e)),getOwnPropertyDescriptor(e,n){if("string"==typeof n){const e=Number(n);if(Number.isInteger(e)&&e>=0&&String(e)===n)return{configurable:!0,enumerable:!0,value:t[e],writable:!0}}return"length"===n?{configurable:!0,enumerable:!1,value:t.length,writable:!0}:Object.getOwnPropertyDescriptor(e,n)}})};Object.setPrototypeOf(arrayObservable.prototype,baseObservable.prototype),Object.setPrototypeOf(arrayObservable,baseObservable),arrayObservable.prototype.bindMap=function(e){const t=arrayObservable(this.map((t,n)=>e.call(this,t,n,this))),n=new WeakRef(t);new FinalizationRegistry(()=>this.removeEventListener("valuechanged",r)).register(t,n);const r=t=>{const r=n.deref();if(r){if("index"in t){const{index:n,newItems:o,oldItems:s}=t;(s&&s.length||o&&o.length)&&r.splice(n,s?.length??0,...o?.map((t,r)=>e.call(this,t,n+r,this))??[])}"reversed"in t&&r.reverse(),"sortFn"in t&&r.sort(t.sortFn)}};return this.addEventListener("valuechanged",r),new Proxy(t,{get:(e,t,n)=>["push","pop","shift","unshift","splice","reverse","sort","fill","copyWithin"].includes(String(t))?()=>{throw new Error("Cannot modify a read-only mapped observable")}:Reflect.get(e,t,n),set(e,t,n,r){if("string"==typeof t){const e=Number(t);if(Number.isInteger(e)&&e>=0&&String(e)===t)throw new Error("Cannot modify any item of a read-only mapped observable")}if("length"===t)throw new Error("Cannot modify length of a read-only mapped observable");return Reflect.set(e,t,n,r)}})},arrayObservable.prototype.optimistic=function(e,t){const n=[],r=e=>n.push(e);return this.addEventListener("valuechanged",r),e(this),this.removeEventListener("valuechanged",r),t.catch(e=>{for(let e=n.length-1;e>=0;e--){const t=n[e];if("index"in t)this.splice(t.index,t.newItems?.length??0,...t.oldItems??[]);else if("reversed"in t)this.reverse();else if("sortedIndices"in t){const e=new Array(t.sortedIndices.length);for(let n=0;n<t.sortedIndices.length;n++)e[t.sortedIndices[n]]=n;const n=new Map;this.forEach((t,r)=>n.set(t,e[r])),this.sort((e,t)=>n.get(e)-n.get(t))}}throw e})},Object.defineProperty(arrayObservable.prototype,Symbol.toStringTag,{value:"arrayObservable",writable:!1,enumerable:!1,configurable:!1});{const e=new FinalizationRegistry(({observers:e,listener:t})=>e.forEach(e=>e.removeEventListener("valuechanged",t)));Function.prototype.computed=function(...t){const n=baseObservable(this),r=new WeakRef(n),o={},s=()=>{const n=r.deref();n?n.notify():(t.forEach(e=>e.removeEventListener("valuechanged",s)),e.unregister(o))};return t.forEach(e=>{e instanceof baseObservable&&e.addEventListener("valuechanged",s)}),e.register(n,{observers:t,listener:s},o),Object.setPrototypeOf(n,Function.prototype.computed.prototype),n}}function cstr(e,...t){const n=t.filter(e=>e instanceof baseObservable);return 0===n.length?e.reduce((e,n,r)=>e+n+(r<t.length?String(t[r]):""),""):(()=>{let n=e[0];for(let r=0;r<t.length;r++){const o=t[r];n+=String(o instanceof baseObservable?o():o),n+=e[r+1]}return n}).computed(...n)}Function.prototype.computed.prototype=Object.create(baseObservable.prototype),Function.prototype.computed.prototype.constructor=Function.prototype.computed,Object.setPrototypeOf(Function.prototype.computed,baseObservable),Object.defineProperty(Function.prototype.computed.prototype,Symbol.toStringTag,{value:"computed",writable:!1,enumerable:!1,configurable:!1});{const e=new WeakMap;new MutationObserver(t=>t.forEach(t=>e.get(t.target)?.get(t.attributeName)?.forEach(e=>e()))).observe(document,{attributes:!0,subtree:!0});var observeElementAttr=(t,n,r)=>{let o=e.get(t);o||e.set(t,o=new Map);let s=o.get(n);s||o.set(n,s=new Set),s.add(r)}}Object.defineProperties(Document.prototype,{$dom:{get(){return e=>new Proxy({},{get:(t,n)=>{if("string"!=typeof n)return;if("toString"===n)return()=>`DOM Proxy for namespace: ${e}`;const r=n.replace(/([A-Z])/g,"-$1").toLowerCase();return(...t)=>{const n=this.createElementNS(e,r);for(const i of s(t))if(null!=i&&!1!==i)if(i.constructor===Object&&void 0===i[Symbol.iterator]&&Symbol.asyncIterator&&void 0===i[Symbol.asyncIterator])for(const[l,c]of Object.entries(i))if("style"===l&&n instanceof HTMLElement)baseObservable.autoBind(c,e=>"string"==typeof e?n.setAttribute("style",e):Object.entries(e).forEach(([e,t])=>baseObservable.autoBind(t,t=>n.style[e]=t,()=>observeElementAttr(n,"style",()=>t(n.style[e])))),e=>observeElementAttr(n,"style",()=>c("string"==typeof e?n.getAttribute("style")||"":Object.assign({},n.style))));else if("on"===l&&"object"==typeof c&&c)for(const[b,f]of Object.entries(c))for(const u of s([f]))"function"==typeof u&&n.addEventListener(b.toLowerCase(),u);else if(l.startsWith("on"))for(const p of s([c]))"function"==typeof p&&n.addEventListener(l.slice(2).toLowerCase(),p);else if("data"===l&&"object"==typeof c&&(n instanceof HTMLElement||n instanceof SVGElement||n instanceof MathMLElement))for(const[y,g]of Object.entries(c))baseObservable.autoBind(g,e=>n.dataset[y]="object"==typeof e?JSON.stringify(e):e,e=>observeElementAttr(n,`data-${y.replace(/([A-Z])/g,"-$1").toLowerCase()}`,()=>{const e=n.dataset[y];try{g(JSON.parse(e))}catch{g(e)}}));else"value"===l&&(n instanceof HTMLInputElement||n instanceof HTMLTextAreaElement||n instanceof HTMLSelectElement)?baseObservable.autoBind(c,e=>n.value=e,()=>n.addEventListener(n instanceof HTMLSelectElement?"change":"input",()=>c(n.value))):"checked"===l&&n instanceof HTMLInputElement&&("checkbox"===i.type||"radio"===i.type)?baseObservable.autoBind(c,e=>n.checked=e,()=>n.addEventListener("change",()=>c(n.checked))):void 0!==c&&baseObservable.autoBind(c,e=>l in n?n[l]=e:n.setAttribute(l,"object"==typeof e?JSON.stringify(e):e),()=>{let e=l in n?n[l]:n.getAttribute(l);try{c(JSON.parse(e))}catch{c(e)}});else if(i instanceof baseObservable)if(i instanceof arrayObservable){const h=new Text;n.append(h);const d=[];function v(e){for(;"function"==typeof e;)e=e.call(n,n);return a(e).filter(e=>null!=e&&!1!==e)}function m(e){if("index"in e){const{index:t,oldItems:n,newItems:r}=e;if(n?.length)for(let e=0;e<n.length;e++){const e=d[t];let n=e.nextSibling;for(;n&&n!==d[t+1];){const e=n;n=n.nextSibling,e.remove()}e.remove(),d.splice(t,1)}if(r?.length)for(let e=0;e<r.length;e++){const n=new Text;(d[t]||h).before(n,...v(r[e])),d.splice(t+e,0,n)}}else if("reversed"in e){const e=[];for(let t=0;t<d.length;t++){const n=d[t];let r=n.nextSibling;const o=[n];for(;r&&(t===d.length-1||r!==d[t+1]);)o.push(r),r=r.nextSibling;e.push(...o)}e.reverse().forEach(e=>h.before(e)),d.reverse()}else if("sortedIndices"in e){const t=e.sortedIndices,n=[];for(let e=0;e<t.length;e++){const r=d[t[e]];let o=r;const s=[];do{s.push(o),o=o.nextSibling}while(o&&!1===t.includes(d.indexOf(o)));n.push(r),s.forEach(e=>h.before(e))}d.splice(0,d.length,...n)}}i().forEach((e,t)=>{const n=new Text;d[t]=n,h.before(n,...v(e))}),i.addEventListener("valuechanged",e=>m(e))}else{const O=new Text;n.append(O);let w=[];function E(){for(const e of w)e.remove();let e=i();for(;"function"==typeof e;)e=e.call(n,n);const t=new DocumentFragment;t.append(...a(e).filter(e=>null!=e&&!1!==e)),w=Array.from(t.children),O.after(t)}E(),i.addEventListener("valuechanged",E)}else Symbol.asyncIterator?function e(t,r){for(const o of a(t).filter(e=>null!=e&&!1!==e&&void 0!==e))if("function"==typeof o[Symbol.asyncIterator]){const t=new Text;r?r.before(t):n.append(t),(async()=>{for await(const n of o)e(n,t)})()}else r?r.before(o):n.append(o)}(i):n.append(...a(i).filter(e=>null!=e&&!1!==e));return n;function o(e){return!(null==e||"string"==typeof e||"function"==typeof e||"function"!=typeof e[Symbol.iterator]||e instanceof Node||e instanceof Date||e instanceof RegExp)}function s(e){return o(e)?Array.from(e).flatMap(s):[e]}function a(e){for(;"function"==typeof e;)e=e.call(n,n);return o(e)?Array.from(e).flatMap(a):[e]}}}})},configurable:!1,enumerable:!0},$html:{get(){return this.$dom("http://www.w3.org/1999/xhtml")},configurable:!1,enumerable:!0},$svg:{get(){return this.$dom("http://www.w3.org/2000/svg")},configurable:!1,enumerable:!0},$mml:{get(){return this.$dom("http://www.w3.org/1998/Math/MathML")},configurable:!1,enumerable:!0}}),Object.defineProperties(Window.prototype,{$dom:{get(){return this.document.$dom},configurable:!1,enumerable:!0},$html:{get(){return this.document.$html},configurable:!1,enumerable:!0},$svg:{get(){return this.document.$svg},configurable:!1,enumerable:!0},$mml:{get(){return this.document.$mml},configurable:!1,enumerable:!0}});const observable=function(e){let t=e;const n=baseObservable(function(e){return 0===arguments.length||Object.is(t,e)||n.tryChange(()=>t=e,{oldValue:t,newValue:e}),t});return Object.setPrototypeOf(n,observable.prototype),n.bindTo=Object.setPrototypeOf(Object.assign((...e)=>n(...e),{type:"to"}),n),n.bindFrom=Object.setPrototypeOf(Object.assign((...e)=>n(...e),{type:"from"}),n),n};Object.setPrototypeOf(observable.prototype,baseObservable.prototype),Object.setPrototypeOf(observable,baseObservable),observable.prototype.type="two-way",observable.prototype.optimistic=function(e,t){const n=this();return this(e(n)),t.catch(e=>{throw this(n),e})},Object.defineProperty(observable.prototype,Symbol.toStringTag,{value:"observable",writable:!1,enumerable:!1,configurable:!1});
//# sourceMappingURL=dom.min.js.map